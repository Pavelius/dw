#include "main.h"

static quest quests[] = {{},
{StMarysHospital, "Когда вы шли по корридору у вас появилось некое плохое предчувствие.", {Luck, -1}, {{"Вы почувствовали укол и потеряли сознание. После этого вы очнулись на улице.", {Lose2Sanity, LeaveOutside}},
{"В последнее мгновение вы заметили, как доктор Мортимор крадется за вами со шприцем, заполненным фосфоресцирующим гелем. Не долго колебаясь вы скрутили его. Город даже заплатил вам награду, которой вы были несказано рады.", {Add3Money, Add2Sanity}},
}},
{StMarysHospital, "Когда врач отвернулся, медсестра Шэрон что - то сунула вам в руку.", {Sneak, -1}, {{"Врач заметил это и быстро выхватил у вас какой-то пергамент одарив медсестру холодным взглядом."},
{"Вы удачно спрятали подарок под полы своей одежды. Позже вы обнаружили что это был старинный свиток.", {AddSpell}},
}},
{StMarysHospital, "Один из медиков пытается научить вас жизни. Его дикие нравоучения сбивают вас столку.", {}, {{0, {Lose1Clue}},
}},
{StMarysHospital, "Вы осматриваете труп, но оказывается, он еще не упокоился. К вашему горлу тянутся отвратительные лапы.", {Fight, -1}, {{"Тварь заставила вас бежать отсюда прямиком на улицу.", {Lose1Sanity, LeaveOutside}},
{"Вы одолели тварь, хотя немного испугались.", {Lose1Sanity}},
}},
{StMarysHospital, "Доктор показывает вам тело другого злосчастного сыщика, спрятанное за занавеской. Бедолагу порвали в клочья.", {Will, -1}, {{"В панике вы выбежали отсюда прямиком на улицу.", {Lose1Sanity, LeaveOutside}},
{"Хладнокровно обыскав труп вы обнаружили нечто интересное.", {AddUniqueItem}},
}},
{StMarysHospital, "Вы согласились пройти курс экспериментального лечения.", {}, {{0, {Add1_3Stamina}},
}},
{StMarysHospital, "Вам удалось заглянуть в карту поступившего на днях пациента, который стал жертвой культистов.", {Lore, 0}, {{"Но ничего нового вы не смогли понять."},
{"Вы узнали о темных ритуалах кое-что новое.", {Add1Clue}},
}},
{Library, "Подняв взгляд, вы видите, что над вами с раздраженным видом нависла Эбигейл Форман.", {Will, -1}, {{"Вы слишком много шумели и она выставила вас на улицу.", {LeaveOutside}},
{"Она оказалась столь любезна, что показала вам где найти нужную книгу.", {AddUniqueItemTome}},
}},
{Library, "Книга, которую вы читаете, источает почти осязаемое зло.", {Lore, -2}, {{"Книга просто пожирает вас.", {Lose2Sanity, Lose2Stamina}},
{"Вы постигаете многие детали тайной угрозы.", {AddDClue}},
}},
{Library, "Когда вы читали старую книгу вы задремали и вам приснился дивный сон. Вы были в стране грез.", {}, {{0, {EncounterDreamland}},
}},
{Library, "Вы листали старую книгу.", {Luck, -2}, {{"В ней небыло ничего интересного."},
{"Вдруг на одной из страниц вы нашли денежную купюру.", {Add5Money}},
}},
{Library, "Вам выписали штраф за задержку книги.", {Money, 4}, {{"Вас выгнали на улицу.", {LeaveOutside}},
{"Заплатив штраф вы остались в библиотеке."},
}},
{Library, "К вам подошла библиотекарша, Эбигейл Форман и что-то пыталась объяснить.", {Will}, {{"В итоге раздасадованная Эбигейл выставляет вас на улицу.", {LeaveOutside}},
{"В итоге она пускает вас в закрытый отдел библиотеки, где вы находите старинный фолиант.", {AddSpell1of2}},
{"В итоге она отдалжила вам экспонат библиотечной выставки.", {AddUniqueItem}},
}},
{Library, "Книга в темном углу библиотеки начинает шептать вам ужасные вещи.", {}, {{0, {Lose1Sanity}},
}},
{UnvisitedIsle, "Ивы качаются на ветру, которого вы не ощущаете.", {Will, -2}, {{"На мгновение в вас проникает ненависть этих древних деревьев к чужаку на их острове.", {Lose3Sanity}},
{"Усилием воли вы сумели себя успокоить и неподдаться животному страху."},
}},
{UnvisitedIsle, "Под сенью плакучей ивы вы обнаружили груду человеческих костей. Cреди останков вы замечаете свиток.", {}, {{0, {Lose1Sanity, AddSpell}},
}},
{UnvisitedIsle, "Какой - то человек изучает старые кости. И вы пытаетесь подойти к нему незаметно.", {Sneak, -1}, {{"Человек расскусил вас после этого быстро скрылся в тени деревьев."},
{"Человек был удивлен вашими способностями оставаться незамеченными.", {AddAllyLegrase}},
}},
{UnvisitedIsle, "Навстречу вам по тропе проносится человек. От краткого соприкосновения ваша рука немеет. Вы оборачиваетесь, но таинственный путник уже исчез.", {Will, -1}, {{"От пережитого вы получили испуг и холодный ожег на руке.", {Lose1Stamina, Lose1Sanity}},
{"От пережитого у вас остался ожег на руке.", {Lose1Stamina}},
}},
{UnvisitedIsle, "Группа культистов собралась на сходку в каменном круге на острове. Подслушаем, о чем они говорят...", {Sneak, -1}, {{"Ничего услышать не удалось."},
{"Вы услушали важную информацию.", {Add2Clue}},
}},
{UnvisitedIsle, "Уже отчалив от берега, вы замечаете в глубине рядом с островом огромную тень. Волны сильнейшего страха захлестывают вас.", {Will, -1}, {{"Страшное проклятье обрушилось на вас.", {AddCurse}},
{"Вы сумели перебороть страх."},
}},
{UnvisitedIsle, "Глядя в ночное небо над островом, вы видите незнакомые созвездия. Здесь совершенно другие звезды!", {}, {{0, {Lose1Sanity, Add1Clue}},
}},
{ArkhamAsylum, "В кабинете доктора вы нашли книгу с записями видений пациентов.", {Lore}, {{"Записи жутковаты, но польза от этого чтения несомненна.", {Add1Clue, Lose1Sanity}},
{"Вы наши важные фрагменты головоломки.", {Add2Clue}},
{"Вы наши важные фрагменты головоломки.", {Add2Clue}},
{"Одна запись содержит жизненно важные данные.", {Add3Clue}},
}},
{ArkhamAsylum, "Вас приняли за пациента, которого доктор Минц велел охране привести к нему для экспериментов.", {Will, -1, 2}, {{"Вы не выдержали эксперемента и лишились памяти.", {LoseMemory}},
{"Исследования благотворно сказались на ваших способностях.", {AddSkill}},
}},
{ArkhamAsylum, "Охранники обнаружили, что вы пробрались на территорию лечебницы.", {Sneak, -1}, {{"Они поймали вас и сдали полиции.", {Arrested}},
{"Вам повезло. Вы смогли прокрасться мимо них на улицу.", {LeaveOutside}},
}},
{ArkhamAsylum, "Сестра Хизер идет! Надо прятаться.", {Speed, -1}, {{"Она вышвырнула вас вон.", {LeaveOutside}},
{"В процессе хотьбы она что-то обронила.", {AddUniqueItem}},
}},
{ArkhamAsylum, "Сестра Хизер случайно ввела вам снотворное. Хотите сопротивляться, чтобы не уснуть?", {Fight, -2, 0, true}, {{"Вы заснули как ребенок.", {Add2Sanity, SkipTurn}},
{"Ничего не произошло."},
}},
{ArkhamAsylum, "\"Все будет хорошо,\" - говорит вам пациент в приемном покое. На вид он вполне вменяемый. Поднявшись, он хлопает вас по руке и уходит. Удивительно, но вы почему-то тоже начали верить в лучшее.", {}, {{0, {Add3Sanity}},
}},
{ArkhamAsylum, "В пыльном шкафу вы обнаруживаете странный препарат, маркированный как \"Усовершенствователь Снов\". Выпить его?", {Lore, -1, 0, true}, {{"Ничего не произошло."},
{"Вас посетили весьма странные и страшные видения, в которых вы смогли научиться новому ритуалу.", {AddSpell}},
}},
{ArkhamAsylum, "Вы слышите крик. Когда вы отворяете тяжелую дверь палаты с целью прояснить происходящее, вам навстречу бросается темная фигура! Ею оказывается сумасшедший в смирительной рубашке, бормочащий что-то о невидимых кошмарах.", {Lore, -2}, {{"Со злостью того что вы его не поняли сумасшедший набросился на вас и сильно побил, перед тем как убежал далее.", {Lose1Stamina}},
{"Похоже вы поняли о чем он говорил.", {Add1Clue}},
}},
};

const quest* hero::getquest(location_s value, int index) {
	adat<quest*, 32> result;
	for(auto& q : quests) {
		if(q.type == value)
			result.add(&q);
	}
	if(result.count) {
		if(index == -1)
			index = rand() % result.count;
		if(index >= (int)result.count)
			index = result.count - 1;
		return result.data[index];
	}
	return 0;
}

void hero::run(const quest* q) {
	if(!q)
		return;
	if(!isready())
		return;
	logs::clear(true);
	logs::add(q->text);
	auto result = 0;
	if(q->roll.id == Money) {
		if(get(Money) < q->roll.bonus)
			logs::add("У вас не хватило денег.");
		else if(logs::yesno(true, "Будете платить [%1i$]?", q->roll.bonus)) {
			set(Money, get(Money) - q->roll.bonus);
			result = 1;
		}
	} else {
		if(q->roll.optional) {
			char skill_temp[128]; q->roll.getname(skill_temp, zendof(skill_temp));
			if(!logs::yesno(true, "Будете делать бросок [%1]?", skill_temp))
				return;
		}
		if(q->roll.id)
			result = roll(q->roll.id, q->roll.bonus, q->roll.difficult, true);
	}
	auto result_maximum = zlen(q->results);
	if(result_maximum < 1)
		result_maximum = 1;
	if(result >= result_maximum)
		result = result_maximum - 1;
	bool discard = false;
	auto apply_actions = 0;
	if(q->results[result].text)
		logs::add(q->results[result].text);
	for(auto a : q->results[result].results) {
		if(!isready())
			break;
		if(!a)
			break;
		apply(a, &discard);
		apply_actions++;
	}
	if(!apply_actions)
		logs::next();
}